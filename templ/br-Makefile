# Makefile for buildroot2
#
# Copyright (C) 1999-2005 by Erik Andersen <andersen@codepoet.org>
# Copyright (C) 2006-2010 by the Buildroot developers <buildroot@uclibc.org>
#
# This program is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation; either version 2 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU
# General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program; if not, write to the Free Software
# Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA
#

#--------------------------------------------------------------
# Just run 'make menuconfig', configure stuff, then run 'make'.
# You shouldn't need to mess with anything beyond this point...
#--------------------------------------------------------------

# Set and export the version string
export BR2_VERSION:=2010.11

# This top-level Makefile can *not* be executed in parallel
.NOTPARALLEL:

# Include Coverity Settings
include coverity_conf.mak

# Include Autoconf automake Settings
include automake_conf.mak

# set PATH & LD_LIBRARY_PATH
export PATH:=/bin:/usr/bin:/usr/local/bin
export LD_LIBRARY_PATH:=

# This PLATFORM_TYPE (emulator|st7108|bcm7346|...) specific cflag is used temporarly for developer to enclose some
# C code for special platform. The value of it is the start with "TARGET_" and followed by the upcase of the
# platform folder name under "ntvtgt".
PLATFORM_TYPE=TARGET_$(shell echo $(notdir $(PWD)|tr a-z A-Z))

BRCM_TARGETS:= TARGET_BCM7346_UCLIBC_BC TARGET_TC7356_UCLIBC_BC TARGET_SAM7231_UCLIBC_BC TARGET_SAM7425_UCLIBC_BC 

ST_TARGETS:= TARGET_ST7108_GLIBC_CT TARGET_ST239_GLIBC_CT

# The PLATFORM_VENDOR is used for platform-specific woraround in MW (NTV5_1-606).
PLATFORM_VENDOR:=PLATFORM_EMULATOR

ifneq ($(findstring $(PLATFORM_TYPE),$(BRCM_TARGETS)), )
PLATFORM_VENDOR=PLATFORM_BRCM
endif

ifneq ($(findstring $(PLATFORM_TYPE),$(ST_TARGETS)), )
PLATFORM_VENDOR=PLATFORM_ST
endif

ifeq ($(BUILD_TYPE),)
BUILD_TYPE:=debug
endif

ifeq ($(BUILD_TYPE),release)
# Setup CFLAGS for release build
O_BUILD_CFLAGS:=-DNDEBUG
	
ifeq ($(PLATFORM_VENDOR), PLATFORM_BRCM)

ifeq ($(CORE_DUMP),1)
# If CORE_DUMP is 1, turn on DEBUG_INIT=1 by default. 
DEBUG_INIT=1
O_BUILD_CFLAGS += -rdynamic -DCORE_DUMP
endif

ifeq ($(DEBUG_INIT),1)

ifeq ($(PERFHOOKS),1)
O_BUILD_CFLAGS += -DPERFHOOKS
endif
endif

endif

# Turn on Backtrace by default
ifeq ($(DEBUG_INIT),1)
O_BUILD_CFLAGS += -rdynamic -DBACKTRACE
endif

else # if BUILD_TYPE is "debug" or "bld"

# For BCM platform, backtrace could not work. So we enable core dump in default.
ifeq ($(PLATFORM_VENDOR),PLATFORM_BRCM)
CORE_DUMP:=1
endif

#set the CFLAGS for bld and debug build
# Eventually these are the options we need to impose
# O_BUILD_ERR = -Werror=shadow -Werror=undef -Werror=uninitialized -Werror=implicit -Werror=missing-prototypes -Werror=cast-align
# O_BUILD_WARN = -Wall -Wunreachable-code -Wparentheses -Wswitch
O_BUILD_CFLAGS:= -rdynamic -g -Wall -Wshadow  -Werror=uninitialized -Wunreachable-code -Wimplicit -Wparentheses -Wswitch -Wmissing-prototypes -Wcast-align  
ifneq ($(PLATFORM_TYPE),TARGET_ST7108_GLIBC_CT)
O_BUILD_CFLAGS += -Werror=undef
endif
ifeq ($(BUILD_TYPE),bld)
ifeq ($(DEBUG_ASSERT),1)
O_BUILD_CFLAGS += -DBACKTRACE -DNTVLOG_NO_STDOUT
else
O_BUILD_CFLAGS += -DNDEBUG -DBACKTRACE
endif
endif
ifeq ($(PERFHOOKS),1)
O_BUILD_CFLAGS += -DPERFHOOKS
endif
#
# TSS symbol to trace memory in framework
#
ifeq ($(OOC_MTRACE),1)
O_BUILD_CFLAGS += -DOOC_MTRACE
endif
ifeq ($(MTRACE),1)
O_BUILD_CFLAGS += -DMTRACE
endif
ifeq ($(TSS_DEBUG),1)
O_BUILD_CFLAGS += -DTSS_DEBUG
endif

ifeq ($(CORE_DUMP),1)
O_BUILD_CFLAGS += -DCORE_DUMP
endif

ifeq ($(EITS_METRICS),1)
O_BUILD_CFLAGS += -DEITS_METRICS
endif

endif # ifeq ($(BUILD_TYPE),release) 

ifeq ($(CONFIG_TYPE),pvr)
O_BUILD_CFLAGS+=-DNTV_PVR
endif


ifeq ($(CONFIG_TYPE),tf_e5)
O_BUILD_CFLAGS+=-DNTV_TF_E5
endif

ifneq ($(LOG_LEVEL), )
O_BUILD_CFLAGS+=-DLOG_LEVEL=$(LOG_LEVEL)
endif

O_BUILD_CFLAGS+=-D$(PLATFORM_TYPE) -D$(PLATFORM_VENDOR)



# absolute path
TOPDIR:=$(shell pwd)
CONFIG_CONFIG_IN=Config.in
CONFIG=package/config
DATE:=$(shell date +%Y%m%d)

# Compute the full local version string so packages can use it as-is
# Need to export it, so it can be got from environment in children (eg. mconf)
export BR2_VERSION_FULL:=$(BR2_VERSION)$(shell $(TOPDIR)/scripts/setlocalversion)

noconfig_targets:=menuconfig nconfig gconfig xconfig config oldconfig randconfig \
	defconfig %_defconfig savedefconfig allyesconfig allnoconfig silentoldconfig release \
	randpackageconfig allyespackageconfig allnopackageconfig \
	source-check help

# Strip quotes and then whitespaces
qstrip=$(strip $(subst ",,$(1)))
#"))

# Variables for use in Make constructs
comma:=,
empty:=
space:=$(empty) $(empty)

ifneq ("$(origin O)", "command line")
O:=output
CONFIG_DIR:=$(TOPDIR)
NEED_WRAPPER=
else
# other packages might also support Linux-style out of tree builds
# with the O=<dir> syntax (E.G. Busybox does). As make automatically
# forwards command line variable definitions those packages get very
# confused. Fix this by telling make to not do so
MAKEOVERRIDES =
# strangely enough O is still passed to submakes with MAKEOVERRIDES
# (with make 3.81 atleast), the only thing that changes is the output
# of the origin function (command line -> environment).
# Unfortunately some packages don't look at origin (E.G. uClibc 0.9.31+)
# To really make O go away, we have to override it.
override O:=$(O)
CONFIG_DIR:=$(O)
# we need to pass O= everywhere we call back into the toplevel makefile
EXTRAMAKEARGS = O=$(O)
NEED_WRAPPER=y
endif


ifneq ($(BUILD_TYPE), debug)
CONFIG_FILE:=$(CONFIG_DIR)/.config_$(BUILD_TYPE)_$(CONFIG_TYPE)
else
CONFIG_FILE:=$(CONFIG_DIR)/.config_$(CONFIG_TYPE)
endif

# Pull in the user's configuration file
ifeq ($(filter $(noconfig_targets),$(MAKECMDGOALS)),)
-include $(CONFIG_FILE)
endif

# Override BR2_DL_DIR if shell variable defined
ifneq ($(BUILDROOT_DL_DIR),)
BR2_DL_DIR:=$(BUILDROOT_DL_DIR)
endif

# To put more focus on warnings, be less verbose as default
# Use 'make V=1' to see the full commands
ifdef V
  ifeq ("$(origin V)", "command line")
    KBUILD_VERBOSE=$(V)
  endif
endif
ifndef KBUILD_VERBOSE
  KBUILD_VERBOSE=0
endif

ifeq ($(KBUILD_VERBOSE),1)
  quiet=
  Q=
ifndef VERBOSE
  VERBOSE=1
endif
else
  quiet=quiet_
  Q=@
endif

# we want bash as shell
SHELL:=$(shell if [ -x "$$BASH" ]; then echo $$BASH; \
	else if [ -x /bin/bash ]; then echo /bin/bash; \
	else echo sh; fi; fi)

# kconfig uses CONFIG_SHELL
CONFIG_SHELL:=$(SHELL)

export SHELL CONFIG_SHELL quiet Q KBUILD_VERBOSE VERBOSE

ifndef HOSTAR
HOSTAR:=ar
endif
ifndef HOSTAS
HOSTAS:=as
endif
ifndef HOSTCC
HOSTCC:=gcc
HOSTCC:=$(shell which $(HOSTCC) || type -p $(HOSTCC) || echo gcc)
endif
HOSTCC_NOCCACHE:=$(HOSTCC)
ifndef HOSTCXX
HOSTCXX:=g++
HOSTCXX:=$(shell which $(HOSTCXX) || type -p $(HOSTCXX) || echo g++)
endif
HOSTCXX_NOCCACHE:=$(HOSTCXX)
ifndef HOSTFC
HOSTFC:=gfortran
endif
ifndef HOSTCPP
HOSTCPP:=cpp
endif
ifndef HOSTLD
HOSTLD:=ld
endif
ifndef HOSTLN
HOSTLN:=ln
endif
ifndef HOSTNM
HOSTNM:=nm
endif
HOSTAR:=$(shell which $(HOSTAR) || type -p $(HOSTAR) || echo ar)
HOSTAS:=$(shell which $(HOSTAS) || type -p $(HOSTAS) || echo as)
HOSTFC:=$(shell which $(HOSTLD) || type -p $(HOSTLD) || echo || which g77 || type -p g77 || echo gfortran)
HOSTCPP:=$(shell which $(HOSTCPP) || type -p $(HOSTCPP) || echo cpp)
HOSTLD:=$(shell which $(HOSTLD) || type -p $(HOSTLD) || echo ld)
HOSTLN:=$(shell which $(HOSTLN) || type -p $(HOSTLN) || echo ln)
HOSTNM:=$(shell which $(HOSTNM) || type -p $(HOSTNM) || echo nm)

export HOSTAR HOSTAS HOSTCC HOSTCXX HOSTFC HOSTLD
export HOSTCC_NOCCACHE HOSTCXX_NOCCACHE

# bash prints the name of the directory on 'cd <dir>' if CDPATH is
# set, so unset it here to not cause problems. Notice that the export
# line doesn't affect the environment of $(shell ..) calls, so
# explictly throw away any output from 'cd' here.
export CDPATH:=

ifneq ($(BUILD_TYPE),debug)
BASE_DIR := $(shell mkdir -p $(O) && cd $(O) >/dev/null && pwd)/$(BUILD_TYPE)_$(CONFIG_TYPE)
IMAGE_POSTFIX := $(BUILD_TYPE)_$(CONFIG_TYPE)
else
BASE_DIR := $(shell mkdir -p $(O) && cd $(O) >/dev/null && pwd)/debug_$(CONFIG_TYPE)
IMAGE_POSTFIX := debug_$(CONFIG_TYPE)
endif

$(if $(BASE_DIR),, $(error output directory "$(O)" does not exist))

export OUTPUT_DIR = $(BASE_DIR)

BUILD_DIR:=$(BASE_DIR)/build


ifeq ($(BR2_HAVE_DOT_CONFIG),y)

# cc-option
# Usage: cflags-y+=$(call cc-option, -march=winchip-c6, -march=i586)
# sets -march=winchip-c6 if supported else falls back to -march=i586
# without checking the latter.
cc-option=$(shell if $(TARGET_CC) $(TARGET_CFLAGS) $(1) -S -o /dev/null -xc /dev/null \
	> /dev/null 2>&1; then echo "$(1)"; else echo "$(2)"; fi ;)

#############################################################
#
# Hide troublesome environment variables from sub processes
#
#############################################################
unexport CROSS_COMPILE
unexport ARCH

GNU_HOST_NAME:=$(shell package/gnuconfig/config.guess)

#############################################################
#
# Setup the proper filename extensions for the host
#
##############################################################
ifneq ($(findstring linux,$(GNU_HOST_NAME)),)
HOST_EXEEXT:=
HOST_LIBEXT:=.a
HOST_SHREXT:=.so
endif
ifneq ($(findstring apple,$(GNU_HOST_NAME)),)
HOST_EXEEXT:=
HOST_LIBEXT:=.a
HOST_SHREXT:=.dylib
endif
ifneq ($(findstring cygwin,$(GNU_HOST_NAME)),)
HOST_EXEEXT:=.exe
HOST_LIBEXT:=.lib
HOST_SHREXT:=.dll
HOST_LOADLIBES="-lcurses -lintl"
export HOST_LOADLIBES
endif
ifneq ($(findstring mingw,$(GNU_HOST_NAME)),)
HOST_EXEEXT:=.exe
HOST_LIBEXT:=.lib
HOST_SHREXT:=.dll
endif

# The preferred type of libs we build for the target
ifeq ($(BR2_PREFER_STATIC_LIB),y)
LIBTGTEXT=.a
#PREFERRED_LIB_FLAGS:=--disable-shared --enable-static
else
LIBTGTEXT=.so
#PREFERRED_LIB_FLAGS:=--disable-static --enable-shared
endif
PREFERRED_LIB_FLAGS:=--enable-static --enable-shared

##############################################################
#
# The list of stuff to build for the target toolchain
# along with the packages to build for the target.
#
##############################################################

ifeq ($(BR2_CCACHE),y)
BASE_TARGETS += host-ccache
endif

ifeq ($(BR2_TOOLCHAIN_BUILDROOT),y)
BASE_TARGETS += uclibc-configured binutils cross_compiler uclibc-target-utils kernel-headers
else
BASE_TARGETS += uclibc
endif
TARGETS:=

# For clean_nemotv
NTV_SRC:=
NTV_EXTERNAL:=
NTV_TEST:=
NETCFG_DATA:=

# the directory of NETWORK configration data 
NETCFG_DIR:=$(NEMOTV_DIR)/../netcfg

# silent mode requested?
QUIET:=$(if $(findstring s,$(MAKEFLAGS)),-q)
# Strip off the annoying quoting
ARCH:=$(call qstrip,$(BR2_ARCH))
ifeq ($(ARCH),xtensa)
ARCH:=$(ARCH)_$(call qstrip,$(BR2_xtensa_core_name))
endif

KERNEL_ARCH:=$(shell echo "$(ARCH)" | sed -e "s/-.*//" \
	-e s/i.86/i386/ -e s/sun4u/sparc64/ \
	-e s/arm.*/arm/ -e s/sa110/arm/ \
	-e s/parisc64/parisc/ \
	-e s/powerpc64/powerpc/ \
	-e s/ppc.*/powerpc/ -e s/mips.*/mips/ \
	-e s/sh.*/sh/)

ZCAT:=$(call qstrip,$(BR2_ZCAT))
BZCAT:=$(call qstrip,$(BR2_BZCAT))
TAR_OPTIONS=$(call qstrip,$(BR2_TAR_OPTIONS)) -xf

GNU_TARGET_SUFFIX:=-$(call qstrip,$(BR2_GNU_TARGET_SUFFIX))

STAGING_DIR:=$(call qstrip,$(BR2_STAGING_DIR))

# packages compiled for the host goes here
HOST_DIR:=$(BASE_DIR)/host

# stamp (dependency) files go here
STAMP_DIR:=$(BASE_DIR)/stamps

BINARIES_DIR:=$(BASE_DIR)/images
TARGET_DIR:=$(BASE_DIR)/target
TOOLCHAIN_DIR=$(BASE_DIR)/toolchain
TARGET_SKELETON=$(TOPDIR)/fs/skeleton

IMAGE_TYPE=$(BUILD_TYPE)
ifneq ($(BUILD_TYPE),release)
	IMAGE_TYPE=debug
endif

ifeq ($(PLATFORM_TYPE),TARGET_ST239_GLIBC_CT)
ifeq ($(BR2_NEMOTV_NETCFG_FRONTEND_CAB),y)
	EXTERNAL_IMAGE_DIR=$(BASE_DIR)/../external/kernel_image_for_usb/release_modules_cab/modules_b2064_h239_ST40_LINUX_32BITS
else
ifeq ($(BR2_NEMOTV_NETCFG_FRONTEND_SAT),y)
	EXTERNAL_IMAGE_DIR=$(BASE_DIR)/../external/kernel_image_for_usb/release_modules_sat/modules_b2064_h239_ST40_LINUX_32BITS
endif	
endif
endif


ifeq ($(PLATFORM_TYPE),TARGET_ST7108_GLIBC_CT)
ifeq ($(BR2_NEMOTV_NETCFG_FRONTEND_CAB),y)
	EXTERNAL_IMAGE_DIR=$(BASE_DIR)/../external/kernel_image_for_usb/$(IMAGE_TYPE)_modules_cab/modules_adi7108_7108_ST40HOST_LINUX_32BITS
else
ifeq ($(BR2_NEMOTV_NETCFG_FRONTEND_SAT),y)
	EXTERNAL_IMAGE_DIR=$(BASE_DIR)/../external/kernel_image_for_usb/$(IMAGE_TYPE)_modules_sat/modules_adi7108_7108_ST40HOST_LINUX_32BITS
endif	
endif
endif

BR2_DEPENDS_DIR=$(BUILD_DIR)/buildroot-config

ifeq ($(BR2_CCACHE),y)
CCACHE:=$(HOST_DIR)/usr/bin/ccache
CCACHE_CACHE_DIR=$(BUILDROOT_CCACHE_DIR)/.buildroot-ccache
HOSTCC := $(CCACHE) $(HOSTCC)
HOSTCXX := $(CCACHE) $(HOSTCXX)
endif

include toolchain/Makefile.in
include package/Makefile.in

#############################################################
#
# You should probably leave this stuff alone unless you know
# what you are doing.
#
#############################################################

all: check_bld_cfg world

# We also need the various per-package makefiles, which also add
# each selected package to TARGETS if that package was selected
# in the .config file.
ifeq ($(BR2_TOOLCHAIN_BUILDROOT),y)
include toolchain/toolchain-buildroot.mk
else ifeq ($(BR2_TOOLCHAIN_EXTERNAL),y)
include toolchain/toolchain-external.mk
else ifeq ($(BR2_TOOLCHAIN_CTNG),y)
include toolchain/toolchain-crosstool-ng.mk
endif

include package/*/*.mk

include boot/common.mk
include target/Makefile.in
include linux/linux.mk

TARGETS+=target-finalize

ifeq ($(BR2_ENABLE_LOCALE_PURGE),y)
TARGETS+=target-purgelocales
endif

include fs/common.mk

O_DEBUG_CFLAGS:="CFLAGS= $(TARGET_CFLAGS) $(O_BUILD_CFLAGS)"

###
## ######################################################################
# Nemo: Append hilda stuff, Will overwrite O_DEBUG_CFLAGS
HILDA_CFLAGS := -I/home/auv/eoe/auv/hilda/inc
HILDA_LDFLAGS := -L/home/auv/eoe/auv/hilda/build/target/7231 -lhilda
O_DEBUG_CFLAGS := "CFLAGS= $(TARGET_CFLAGS) $(O_BUILD_CFLAGS) $(HILDA_CFLAGS)" "LDFLAGS= $(TARGET_LDFLAGS) $(HILDA_LDFLAGS)"

TARGETS+=erase-fakeroots

TARGETS_CLEAN:=$(patsubst %,%-clean,$(TARGETS))
TARGETS_SOURCE:=$(patsubst %,%-source,$(TARGETS) $(BASE_TARGETS))
TARGETS_DIRCLEAN:=$(patsubst %,%-dirclean,$(TARGETS))
TARGETS_ALL:=$(patsubst %,__real_tgt_%,$(TARGETS))
TARGETS_CLEAN_ALIAS:=$(patsubst %,%_clean,$(TARGETS))
# host-* dependencies have to be handled specially, as those aren't
# visible in Kconfig and hence not added to a variable like TARGETS.
# instead, find all the host-* targets listed in each <PKG>_DEPENDENCIES
# variable for each enabled target.
# Notice: this only works for newstyle gentargets/autotargets packages
TARGETS_HOST_DEPS = $(sort $(filter host-%,$(foreach dep,\
		$(addsuffix _DEPENDENCIES,$(call UPPERCASE,$(TARGETS))),\
		$($(dep)))))
# Host packages can in turn have their own dependencies. Likewise find
# all the package names listed in the HOST_<PKG>_DEPENDENCIES for each
# host package found above. Ideally this should be done recursively until
# no more packages are found, but that's hard to do in make, so limit to
# 1 level for now.
HOST_DEPS = $(sort $(foreach dep,\
		$(addsuffix _DEPENDENCIES,$(call UPPERCASE,$(TARGETS_HOST_DEPS))),\
		$($(dep))))
HOST_SOURCE += $(addsuffix -source,$(sort $(TARGETS_HOST_DEPS) $(HOST_DEPS)))

# all targets depend on the crosscompiler and it's prerequisites
$(TARGETS_ALL): __real_tgt_%: $(BASE_TARGETS) %

dirs: $(DL_DIR) $(TOOLCHAIN_DIR) $(BUILD_DIR) $(STAGING_DIR) $(TARGET_DIR) \
	$(HOST_DIR) $(BR2_DEPENDS_DIR) $(BINARIES_DIR) $(STAMP_DIR)

$(BASE_TARGETS): dirs

$(BUILD_DIR)/buildroot-config/auto.conf: $(CONFIG_FILE)
	yes ""|$(MAKE) $(EXTRAMAKEARGS) HOSTCC="$(HOSTCC_NOCCACHE)" HOSTCXX="$(HOSTCXX_NOCCACHE)" oldconfig
	$(MAKE) $(EXTRAMAKEARGS) HOSTCC="$(HOSTCC_NOCCACHE)" HOSTCXX="$(HOSTCXX_NOCCACHE)" silentoldconfig

prepare: $(BUILD_DIR)/buildroot-config/auto.conf

check_settings:
ifeq ($(BUILDROOT_DL_DIR),)
	@echo 'Please do "source set_env.sh" or "source set_env_bash.sh" before "make".'
	exit 1
endif

ifeq ($(NEMOTV_DIR),)
	@echo 'Please do "source set_env.sh" or "source set_env_bash.sh" before "make".'
	exit 1
endif

coverity_commit:
# do coverity submit only when COVERITY flag is set
ifeq ($(COVERITY),1)
	@echo ====================================================================
	@echo Committing information to $(COVERITY_SERVER) under $(COVERITY_PRODUCT)
	@echo ====================================================================
ifdef COVERITY_PUBLIC_RUN
	@$(COVERITY_BIN)/cov-commit-defects \
		--dir $(COVERITY_INT_DIR) \
		--remote $(COVERITY_SERVER) \
		--port $(COVERITY_SERVER_PORT) \
		--product $(COVERITY_PRODUCT) \
		--user $(COVERITY_USER) \
		--password $(COVERITY_PASSWORD)
else
	@$(COVERITY_BIN)/cov-commit-defects \
		--dir $(COVERITY_INT_DIR) \
		--remote $(COVERITY_SERVER) \
		--port $(COVERITY_SERVER_PORT) \
		--product $(COVERITY_PRODUCT) \
		--user $(COVERITY_USER) \
		--private
endif
endif


world: check_settings prepare dependencies dirs $(BASE_TARGETS) $(TARGETS_ALL) coverity_commit

.PHONY: all world dirs clean distclean source outputmakefile check_bld_cfg\
	nemotv_src-dirclean nemotv_test-dirclean nemotv_netcfg-dirclean nemotv-dirclean \
	$(BASE_TARGETS) $(TARGETS) $(TARGETS_ALL) \
	$(TARGETS_CLEAN) $(TARGETS_DIRCLEAN) $(TARGETS_SOURCE) \
	$(DL_DIR) $(TOOLCHAIN_DIR) $(BUILD_DIR) $(STAGING_DIR) $(TARGET_DIR) \
	$(HOST_DIR) $(BR2_DEPENDS_DIR) $(BINARIES_DIR) $(STAMP_DIR) $(TARGETS_CLEAN_ALIAS)

#############################################################
#
# staging and target directories do NOT list these as
# dependencies anywhere else
#
#############################################################
$(DL_DIR) $(TOOLCHAIN_DIR) $(BUILD_DIR) $(HOST_DIR) $(BINARIES_DIR) $(STAMP_DIR):
	@mkdir -p $@

$(STAGING_DIR):
	@mkdir -p $(STAGING_DIR)/bin
	@mkdir -p $(STAGING_DIR)/lib
	@mkdir -p $(STAGING_DIR)/usr/lib
	@mkdir -p $(STAGING_DIR)/usr/include
	@mkdir -p $(STAGING_DIR)/usr/bin

ifeq ($(BR2_ROOTFS_SKELETON_CUSTOM),y)
TARGET_SKELETON=$(BR2_ROOTFS_SKELETON_CUSTOM_PATH)
endif

$(BUILD_DIR)/.root:
	mkdir -p $(TARGET_DIR)
	if ! [ -d "$(TARGET_DIR)/bin" ]; then \
		if [ -d "$(TARGET_SKELETON)" ]; then \
			cp -fa $(TARGET_SKELETON)/* $(TARGET_DIR)/; \
		fi; \
		if [ -d "$(EXTERNAL_IMAGE_DIR)" ]; then \
			cp -fa $(EXTERNAL_IMAGE_DIR) $(TARGET_DIR)/root/; \
		fi; \
		if [ -d "$(TARGET_SKELETON_PATCH)" ]; then \
			toolchain/patch-kernel.sh $(TARGET_DIR) $(TARGET_SKELETON_PATCH)/ \*patch\*; \
		fi; \
		touch $(STAGING_DIR)/.fakeroot.00000; \
	fi
	-find $(TARGET_DIR) -type d -name CVS -print0 -o -name .svn -print0 | xargs -0 rm -rf
	-find $(TARGET_DIR) -type f \( -name .empty -o -name '*~' \) -print0 | xargs -0 rm -rf
	touch $@

$(TARGET_DIR): $(BUILD_DIR)/.root

erase-fakeroots:
	rm -f $(BUILD_DIR)/.fakeroot*

target-finalize:
ifeq ($(BR2_HAVE_DEVFILES),y)
	( scripts/copy.sh $(STAGING_DIR) $(TARGET_DIR) )
else
	rm -rf $(TARGET_DIR)/usr/include $(TARGET_DIR)/usr/lib/pkgconfig $(TARGET_DIR)/usr/share/aclocal
	rm -rf $(TARGET_DIR)/$(NEMOTV_INSTALL_DIR)/include $(TARGET_DIR)/$(NEMOTV_INSTALL_DIR)/lib/pkgconfig $(TARGET_DIR)/$(NEMOTV_INSTALL_DIR)/share/aclocal
	find $(TARGET_DIR)/lib \( -name '*.a' -o -name '*.la' \) -print0 | xargs -0 rm -f
	find $(TARGET_DIR)/usr/lib \( -name '*.a' -o -name '*.la' \) -print0 | xargs -0 rm -f
	find $(TARGET_DIR)/$(NEMOTV_INSTALL_DIR)/lib \( -name '*.a' -o -name '*.la' \) -print0 | xargs -0 rm -f

endif
ifneq ($(BR2_PACKAGE_GDB),y)
	rm -rf $(TARGET_DIR)/usr/share/gdb
endif
ifneq ($(BR2_HAVE_DOCUMENTATION),y)
	rm -rf $(TARGET_DIR)/usr/man $(TARGET_DIR)/usr/share/man
	rm -rf $(TARGET_DIR)/usr/info $(TARGET_DIR)/usr/share/info
	rm -rf $(TARGET_DIR)/usr/doc $(TARGET_DIR)/usr/share/doc
	rm -rf $(TARGET_DIR)/usr/share/gtk-doc
	rm -rf $(TARGET_DIR)/usr/share/locale
#	-rmdir $(TARGET_DIR)/usr/share 2>/dev/null
endif

ifeq ($(BUILD_TYPE), release)
	find $(TARGET_DIR) -type f '!' -name 'libthread_db*.so*' -a '!' -name '*.ko'| \
		xargs $(STRIPCMD) 2>/dev/null || true
	find $(TARGET_DIR) -type f -name '*.ko' | \
		xargs -r $(KSTRIPCMD) || true
endif

	mkdir -p $(TARGET_DIR)/etc
	# Mandatory configuration file and auxilliary cache directory
	# for recent versions of ldconfig
	touch $(TARGET_DIR)/etc/ld.so.conf
	echo "include ld.so.conf.d/*.conf" >> $(TARGET_DIR)/etc/ld.so.conf
	mkdir -p $(TARGET_DIR)/var/cache/ldconfig
	if [ -x "$(TARGET_CROSS)ldconfig" ]; \
	then \
		$(TARGET_CROSS)ldconfig -r $(TARGET_DIR); \
#	else \
#		/sbin/ldconfig -r $(TARGET_DIR); \
	fi
	echo $(BR2_VERSION_FULL) > $(TARGET_DIR)/etc/br-version

ifneq ($(BR2_ROOTFS_POST_BUILD_SCRIPT),"")
	$(BR2_ROOTFS_POST_BUILD_SCRIPT) $(TARGET_DIR)
endif

ifeq ($(BR2_ENABLE_LOCALE_PURGE),y)
LOCALE_WHITELIST=$(BUILD_DIR)/locales.nopurge
LOCALE_NOPURGE=$(call qstrip,$(BR2_ENABLE_LOCALE_WHITELIST))

target-purgelocales:
	rm -f $(LOCALE_WHITELIST)
	for i in $(LOCALE_NOPURGE); do echo $$i >> $(LOCALE_WHITELIST); done

	for dir in $(wildcard $(addprefix $(TARGET_DIR),/usr/share/locale /usr/share/X11/locale /usr/man /usr/share/man)); \
	do \
		for lang in $$(cd $$dir; ls .|grep -v man); \
		do \
			grep -qx $$lang $(LOCALE_WHITELIST) || rm -rf $$dir/$$lang; \
		done; \
	done
endif

source: $(TARGETS_SOURCE) $(HOST_SOURCE)

_source-check:
	$(MAKE) DL_MODE=SOURCE_CHECK $(EXTRAMAKEARGS) source

external-deps:
	@$(MAKE) -Bs DL_MODE=SHOW_EXTERNAL_DEPS $(EXTRAMAKEARGS) source | sort -u

show-targets:
	@echo $(TARGETS)

otvall:
	@echo "NTV_SRC:"
	@echo $(NTV_SRC)
	@echo 
	@echo "NTV_EXTERNAL:"
	@echo $(NTV_EXTERNAL)
	@echo 
	@echo "NTV_TEST:"
	@echo $(NTV_TEST)
	@echo 
	@echo "NETCFG_DATA:"
	@echo $(NETCFG_DATA)
	@echo 
	@echo "Everything:"
	@echo $(NTV_SRC) $(NTV_EXTERNAL) $(NTV_TEST) $(NETCFG_DATA) 

else 
# BR2_HAVE_DOT_CONFIG is not defined

all: check_bld_cfg menuconfig

# configuration
# ---------------------------------------------------------------------------

HOSTCFLAGS=$(CFLAGS_FOR_BUILD)
export HOSTCFLAGS

$(BUILD_DIR)/buildroot-config/%onf:
	mkdir -p $(@D)/lxdialog
	$(MAKE) CC="$(HOSTCC_NOCCACHE)" HOSTCC="$(HOSTCC_NOCCACHE)" obj=$(@D) -C $(CONFIG) -f Makefile.br $(@F)

COMMON_CONFIG_ENV = \
	KCONFIG_AUTOCONFIG=$(BUILD_DIR)/buildroot-config/auto.conf \
	KCONFIG_AUTOHEADER=$(BUILD_DIR)/buildroot-config/autoconf.h \
	KCONFIG_TRISTATE=$(BUILD_DIR)/buildroot-config/tristate.config \
	BUILDROOT_CONFIG=$(CONFIG_FILE)

xconfig: $(BUILD_DIR)/buildroot-config/qconf outputmakefile
	@mkdir -p $(BUILD_DIR)/buildroot-config
	@$(COMMON_CONFIG_ENV) $< $(CONFIG_CONFIG_IN)

gconfig: $(BUILD_DIR)/buildroot-config/gconf outputmakefile
	@mkdir -p $(BUILD_DIR)/buildroot-config
	@$(COMMON_CONFIG_ENV) srctree=$(TOPDIR) $< $(CONFIG_CONFIG_IN)

ifneq ($(wildcard $(HOME)/print.pdf),) 
menuconfig: $(BUILD_DIR)/buildroot-config/mconf $(BUILD_DIR)/buildroot-config/conf 
else
menuconfig: $(BUILD_DIR)/buildroot-config/mconf outputmakefile 
endif
	@mkdir -p $(BUILD_DIR)/buildroot-config
	@$(COMMON_CONFIG_ENV) $< $(CONFIG_CONFIG_IN)
ifneq ($(wildcard $(HOME)/print.pdf),) 
	@yes "n"|./menuconfig_one_for_all_checked.sh $(shell cd $(dir $(CONFIG_FILE));pwd)/$(notdir $(CONFIG_FILE)) $(HOME)/print.pdf $(BUILD_DIR)
	@rm  $(HOME)/print.pdf
endif

nconfig: $(BUILD_DIR)/buildroot-config/nconf outputmakefile
	@mkdir -p $(BUILD_DIR)/buildroot-config
	@$(COMMON_CONFIG_ENV) $< $(CONFIG_CONFIG_IN)

config: $(BUILD_DIR)/buildroot-config/conf outputmakefile
	@mkdir -p $(BUILD_DIR)/buildroot-config
	@$(COMMON_CONFIG_ENV) $< $(CONFIG_CONFIG_IN)

oldconfig: $(BUILD_DIR)/buildroot-config/conf outputmakefile
	mkdir -p $(BUILD_DIR)/buildroot-config
	@$(COMMON_CONFIG_ENV) $< --oldconfig $(CONFIG_CONFIG_IN)

randconfig: $(BUILD_DIR)/buildroot-config/conf outputmakefile
	@mkdir -p $(BUILD_DIR)/buildroot-config
	@$(COMMON_CONFIG_ENV) $< --randconfig $(CONFIG_CONFIG_IN)

allyesconfig: $(BUILD_DIR)/buildroot-config/conf outputmakefile
	@mkdir -p $(BUILD_DIR)/buildroot-config
	@$(COMMON_CONFIG_ENV) $< --allyesconfig $(CONFIG_CONFIG_IN)

allnoconfig: $(BUILD_DIR)/buildroot-config/conf outputmakefile
	@mkdir -p $(BUILD_DIR)/buildroot-config
	@$(COMMON_CONFIG_ENV) $< --allnoconfig $(CONFIG_CONFIG_IN)

randpackageconfig: $(BUILD_DIR)/buildroot-config/conf outputmakefile
	@mkdir -p $(BUILD_DIR)/buildroot-config
	@grep -v BR2_PACKAGE_ $(CONFIG_FILE) > $(CONFIG_FILE).nopkg
	@$(COMMON_CONFIG_ENV) \
		KCONFIG_ALLCONFIG=$(CONFIG_FILE).nopkg \
		$< --randconfig $(CONFIG_CONFIG_IN)
	@rm -f $(CONFIG_FILE).nopkg

allyespackageconfig: $(BUILD_DIR)/buildroot-config/conf outputmakefile
	@mkdir -p $(BUILD_DIR)/buildroot-config
	@grep -v BR2_PACKAGE_ $(CONFIG_FILE) > $(CONFIG_FILE).nopkg
	@$(COMMON_CONFIG_ENV) \
		KCONFIG_ALLCONFIG=$(CONFIG_FILE).nopkg \
		$< --allyesconfig $(CONFIG_CONFIG_IN)
	@rm -f $(CONFIG_FILE).nopkg

allnopackageconfig: $(BUILD_DIR)/buildroot-config/conf outputmakefile
	@mkdir -p $(BUILD_DIR)/buildroot-config
	@grep -v BR2_PACKAGE_ $(CONFIG_FILE) > $(CONFIG_FILE).nopkg
	@$(COMMON_CONFIG_ENV) \
		KCONFIG_ALLCONFIG=$(CONFIG_FILE).nopkg \
		$< --allnoconfig $(CONFIG_CONFIG_IN)
	@rm -f $(CONFIG_FILE).nopkg

silentoldconfig: $(BUILD_DIR)/buildroot-config/conf outputmakefile
	@mkdir -p $(BUILD_DIR)/buildroot-config
	$(COMMON_CONFIG_ENV) $< --silentoldconfig $(CONFIG_CONFIG_IN)

defconfig: $(BUILD_DIR)/buildroot-config/conf outputmakefile
	@mkdir -p $(BUILD_DIR)/buildroot-config
	@$(COMMON_CONFIG_ENV) $< --defconfig $(CONFIG_CONFIG_IN)

%_defconfig: $(BUILD_DIR)/buildroot-config/conf $(TOPDIR)/configs/%_defconfig outputmakefile
	@mkdir -p $(BUILD_DIR)/buildroot-config
	@$(COMMON_CONFIG_ENV) $< --defconfig=$(TOPDIR)/configs/$@ $(CONFIG_CONFIG_IN)

savedefconfig: $(BUILD_DIR)/buildroot-config/conf outputmakefile
	@mkdir -p $(BUILD_DIR)/buildroot-config
	@$(COMMON_CONFIG_ENV) $< --savedefconfig=$(TOPDIR)/defconfig $(CONFIG_CONFIG_IN)

# check if download URLs are outdated
source-check: allyesconfig
	$(MAKE) $(EXTRAMAKEARGS) _source-check

endif # ifeq ($(BR2_HAVE_DOT_CONFIG),y)

nemotv_src-dirclean: $(patsubst %, %-dirclean,$(NTV_SRC) $(NTV_EXTERNAL))

nemotv_test-dirclean: $(patsubst %, %-dirclean,$(NTV_TEST))

nemotv_netcfg-dirclean: $(patsubst %, %-dirclean,$(NETCFG_DATA))

nemotv-dirclean:nemotv_src-dirclean nemotv_test-dirclean nemotv_netcfg-dirclean

#############################################################
#
# map clean_% to %-dirclean
#
#############################################################
clean_%: %-dirclean
	@echo '===> $(patsubst clean_%,%,$@) is cleaned up.'
#############################################################
#
# Comet Component
#
#############################################################
touch_%: $(NEMOTV_DIR)/src/%
	rm  -f $(BASE_DIR)/build/$(shell echo $@ | sed -e "s/touch_//")/.source

#############################################################
#
# NemoTV Test Component
#
#############################################################
touch_%: $(NEMOTV_DIR)/test/%
	rm  -f $(BASE_DIR)/build/$(shell echo $@ | sed -e "s/touch_//")/.source

#############################################################
#
# Cleanup and misc junk
#
#############################################################

# outputmakefile generates a Makefile in the output directory, if using a
# separate output directory. This allows convenient use of make in the
# output directory.
outputmakefile:
ifeq ($(NEED_WRAPPER),y)
	$(Q)$(TOPDIR)/scripts/mkmakefile $(TOPDIR) $(O)
endif

clean:	check_bld_cfg
	@echo "Clean the build of BUILD_TYPE=$(BUILD_TYPE) CONFIG_TYPE=$(CONFIG_TYPE)"
	rm -rf $(BASE_DIR)

distclean: clean
ifeq ($(DL_DIR),$(TOPDIR)/dl)
	rm -rf $(DL_DIR)
endif
ifeq ($(O),output)
	rm -rf $(O)
endif
	rm -rf $(CONFIG_FILE) $(CONFIG_FILE).old $(CONFIG_DIR)/.auto.deps

configured: dirs kernel-headers uclibc-config busybox-config linux26-config

prepatch:	gcc-patched binutils-patched gdb-patched uclibc-patched

cross: $(BASE_TARGETS)

#Only for emulator.Run emulator now.
#set the emulator log output fd(stdio/file)
ifneq ($(LOG), )
export CONSOLE=console=ttyS0
ifeq ($(LOG),stdio)
export LOG_OUTPUT:=$(LOG)
else
export LOG_OUTPUT:=file:$(LOG)
endif
endif

ifeq ($(BUILD_TYPE), release)
ifeq ($(BR2_PACKAGE_NEMOTV_SYSINIT_EMULATOR),y)
export BOOT_IP:=ip=dhcp
endif
endif

run: check_bld_cfg
	cd $(BASE_DIR);$(O)/run.sh
	
ifeq ($(DEBUG_INIT),1)
SHOW_LOG:=1
endif

ifeq ($(SHOW_LOG),)
SHOW_LOG:=0
endif

image: world

ifeq ($(BUILD_TYPE), release)
	@echo "Creating all in one image for release"
	@cd $(O);./make_ntv_bin.sh $(IMAGE_POSTFIX) $(SHOW_LOG)
else
ifeq ($(PLATFORM_TYPE),TARGET_EMULATOR_GLIBC_CT)
	@echo "Creating emulator image of $(IMAGE_POSTFIX)"
	@cd $(BASE_DIR);$(O)/build-ext2-vdi $(IMAGE_POSTFIX) "emulator"  $(EMULATOR_NETCFG)
endif

ifeq ($(PLATFORM_TYPE),TARGET_BCM7346_UCLIBC_BC)
	@echo "Creating bcm7346 image of $(IMAGE_POSTFIX)"
	@cd $(BASE_DIR);$(O)/build-usb-img $(IMAGE_POSTFIX) "7346"
endif

ifeq ($(PLATFORM_TYPE),TARGET_ST7108_GLIBC_CT)
	@echo "Creating bcm7108 image of $(IMAGE_POSTFIX)"
	@cd $(BASE_DIR);$(O)/build-usb-img $(IMAGE_POSTFIX) "7108"
endif

ifeq ($(PLATFORM_TYPE),TARGET_ST239_GLIBC_CT)
	@echo "Creating ST239 image of $(IMAGE_POSTFIX)"
	@cd $(BASE_DIR);$(O)/build-usb-img $(IMAGE_POSTFIX) "239"
endif

ifeq ($(PLATFORM_TYPE),TARGET_SAM7231_UCLIBC_BC)
	@echo "Creating sam7231 image of $(IMAGE_POSTFIX)"
	@cd $(BASE_DIR);$(O)/build-usb-img $(IMAGE_POSTFIX) "7231"
endif

ifeq ($(PLATFORM_TYPE),TARGET_SAM7425_UCLIBC_BC)
	@echo "Creating sam7425 image of $(IMAGE_POSTFIX)"
	@cd $(BASE_DIR);$(O)/build-usb-img $(IMAGE_POSTFIX) "7425"
endif

ifeq ($(PLATFORM_TYPE),TARGET_TC7356_UCLIBC_BC)
	@echo "Creating technicolor 7356 image of $(IMAGE_POSTFIX)"
	@cd $(BASE_DIR);$(O)/build-usb-img $(IMAGE_POSTFIX) "7356"
endif
endif


ifeq ($(BUILD_TYPE), release)
ifeq ($(PLATFORM_TYPE),TARGET_TC7356_UCLIBC_BC)
stream:
	@cd $(O);./make_ntv_bin.sh $(IMAGE_POSTFIX) $(SHOW_LOG) $@
endif
endif
#end of Only for emulator

check_bld_cfg:
	@echo ''
	@echo "Build with BUILD_TYPE=$(BUILD_TYPE) CONFIG_TYPE=$(CONFIG_TYPE)\""
	@(if [ ! -f $(CONFIG_FILE) ];then \
	echo "";\
	echo "Build Error: The Config file \"$(CONFIG_FILE)\" dose not exist.";\
	echo "That means this target does not support \"BUILD_TYPE=$(BUILD_TYPE) CONFIG_TYPE=$(CONFIG_TYPE)\" .";\
	echo "Please Check the BUILD_TYPE or CONFIG_TYPE set by you.";\
	exit 1; \
	fi)
	@echo ''
	
help:
	@echo 'Cleaning:'
	@echo '  clean              - delete all files created by build'
	@echo '  distclean          - delete all non-source files (including .config)'
	@echo '  clean'
	@echo '    options:'
	@echo '      BUILD_TYPE=debug|release|bld|null    - delete release bld or debug(default) build'
	@echo '      CONFIG_TYPE=zapper|tf|pvr|hdi|tf_e5|all        - delete the build with special configrations'
	@echo
	@echo 'Build:'
	@echo '  all        - make world'
	@echo '    options:'
	@echo '      BUILD_TYPE=debug|release|bld|null   - release bld or debug(default) build'
	@echo '      CONFIG_TYPE=zapper|tf|pvr|hdi|tf_e5|all        - with special configrations'
	@echo
	@echo 'Run: (only for emulator now)'
	@echo '  run        - run the world'
	@echo '    options:'
	@echo '      BUILD_TYPE=debug|release|bld|null    - release bld or debug(default) build'
	@echo '      CONFIG_TYPE=zapper|tf|pvr|hdi|tf_e5|all          - with special configrations'
	@echo
	@echo 'Image: (only for emulator now)'
	@echo '  image      - image the world'
	@echo '    options:'
	@echo '      BUILD_TYPE=debug|release|bld|null    - release bld or debug(default) image'
	@echo '      CONFIG_TYPE=zapper|tf|pvr|hdi|tf_e5|all          - with special configrations'
	@echo
	@echo 'NemoTV Component:'
	@echo '  touch_<NEMOTV_COMPONENT_NAME> - touch nemotv component file(s) for incremental build.'
	@echo '  clean_<NEMOTV_COMPONENT_NAME> - remove nemotv component directory for clean build for that component.'
	@echo
	@echo 'Configuration:'
	@echo '  menuconfig             - interactive curses-based configurator'
	@echo '  xconfig                - interactive Qt-based configurator'
	@echo '  gconfig                - interactive GTK-based configurator'
	@echo '  oldconfig              - resolve any unresolved symbols in .config'
	@echo '  randconfig             - New config with random answer to all options'
	@echo '  defconfig              - New config with default answer to all options'
	@echo '  allyesconfig           - New config where all options are accepted with yes'
	@echo '  allnoconfig            - New config where all options are answered with no'
	@echo '  randpackageconfig      - New config with random answer to package options'
	@echo '  allyespackageconfig    - New config where pkg options are accepted with yes'
	@echo '  allnopackageconfig     - New config where package options are answered with no'
	@echo '  configured             - make {uclibc/busybox/linux26}-config'
	@echo
	@echo 'Miscellaneous:'
	@echo '  source                 - download all sources needed for offline-build'
	@echo '  source-check           - check all packages for valid download URLs'
	@echo '  external-deps          - list external packages used'
	@echo '  doc			        - generate doxygen document in html and pdf format'
	@echo
	@$(foreach b, $(notdir $(wildcard $(TOPDIR)/configs/*_defconfig)), \
	  printf "  %-35s - Build for %s\\n" $(b) $(b:_defconfig=);)
	@echo
	@echo 'See docs/README and docs/buildroot.html for further details'
	@echo

release: OUT=buildroot-$(BR2_VERSION)

release:
	git archive --format=tar --prefix=$(OUT)/ master|gzip -9 >$(OUT).tar.gz

doc:
	$(NEMOTV_DIR)/tool/doxygen doxygen_config
#	(cd $(NEMOTV_DIR)/doc/latex/; make pdf )
ifneq	($(BROWSER),)
	$(BROWSER) $(NEMOTV_DIR)/doc/html/index.html
endif

.PHONY: $(noconfig_targets)

